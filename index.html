<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AreaCalc HK â€” Floor Plan Area Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --ink:      #0a0f1a;
  --paper:    #f5f2eb;
  --accent:   #d4520a;
  --accent2:  #1a5c8a;
  --muted:    #7a7469;
  --rule:     #d0cab8;
  --success:  #2a6b3a;
  --warn:     #a85000;
  --danger:   #b01a1a;
  --card-bg:  #fdfbf7;
  --mono:     'DM Mono', monospace;
  --sans:     'Syne', sans-serif;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--sans);
  background: var(--paper);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ Grid lines background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(10,15,26,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(10,15,26,0.04) 1px, transparent 1px);
  background-size: 48px 48px;
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  position: relative; z-index: 10;
  border-bottom: 2px solid var(--ink);
  padding: 0 48px;
  display: flex; align-items: stretch; justify-content: space-between;
  background: var(--ink);
}

.header-logo {
  padding: 20px 0;
  display: flex; align-items: center; gap: 14px;
}

.logo-mark {
  width: 38px; height: 38px;
  background: var(--accent);
  display: grid; grid-template-columns: 1fr 1fr; gap: 3px; padding: 5px;
  flex-shrink: 0;
}
.logo-mark span { background: var(--paper); display: block; }
.logo-mark span:nth-child(3) { background: transparent; border: 1.5px solid var(--paper); }

.logo-text { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; color: var(--paper); }
.logo-text em { font-style: normal; color: var(--accent); }

.header-meta { display: flex; align-items: center; gap: 32px; }

.header-badge {
  font-family: var(--mono);
  font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
  color: rgba(245,242,235,0.5);
  border-left: 1px solid rgba(245,242,235,0.15);
  padding-left: 24px; line-height: 1.6;
}

.status-dot {
  display: inline-block; width: 7px; height: 7px;
  border-radius: 50%; background: #4ade80; margin-right: 6px;
  animation: pulse 2s ease-in-out infinite;
}
.status-dot.offline { background: #f87171; animation: none; }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

/* â”€â”€ Demo Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.demo-banner {
  position: relative; z-index: 5;
  background: var(--accent);
  padding: 10px 48px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 16px;
}
.demo-banner-text {
  font-size: 12px; font-weight: 700;
  letter-spacing: 0.5px; color: var(--paper);
  display: flex; align-items: center; gap: 10px;
}
.demo-banner-text span {
  font-family: var(--mono); font-size: 10px;
  background: rgba(255,255,255,0.2);
  padding: 2px 8px; letter-spacing: 1px; text-transform: uppercase;
}
.demo-banner-actions { display: flex; gap: 12px; align-items: center; }
.btn-load-demo {
  font-family: var(--sans); font-size: 11px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 7px 16px;
  background: var(--paper); color: var(--accent);
  border: none; cursor: pointer; transition: all 0.15s;
}
.btn-load-demo:hover { background: var(--ink); color: var(--paper); }
.btn-dismiss-demo {
  font-family: var(--mono); font-size: 11px;
  color: rgba(245,242,235,0.7);
  background: none; border: none; cursor: pointer;
  text-decoration: underline;
}

/* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main {
  position: relative; z-index: 1;
  max-width: 1200px; margin: 0 auto;
  padding: 56px 48px 80px;
}

.page-title {
  margin-bottom: 48px; border-bottom: 1px solid var(--rule);
  padding-bottom: 32px;
  display: flex; justify-content: space-between; align-items: flex-end;
}

.page-title h1 {
  font-size: clamp(32px, 5vw, 52px); font-weight: 800;
  line-height: 1.05; letter-spacing: -1.5px;
}
.page-title h1 span { display: block; color: var(--accent); }

.spec-tag {
  font-family: var(--mono); font-size: 11px;
  color: var(--muted); text-align: right; line-height: 1.8;
}
.spec-tag strong { color: var(--ink); font-weight: 500; }

/* â”€â”€ Two-column grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout {
  display: grid; grid-template-columns: 1fr 380px;
  gap: 32px; align-items: start;
}

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card { background: var(--card-bg); border: 1.5px solid var(--rule); border-radius: 2px; }

.card-header {
  padding: 16px 24px; border-bottom: 1.5px solid var(--rule);
  display: flex; align-items: center; justify-content: space-between;
}
.card-header h2 {
  font-size: 13px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase; color: var(--ink);
}
.card-label { font-family: var(--mono); font-size: 10px; color: var(--muted); letter-spacing: 0.5px; }
.card-body { padding: 24px; }

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-bar {
  display: flex; border-bottom: 1.5px solid var(--rule);
  background: var(--paper);
}
.tab-btn {
  font-family: var(--sans); font-size: 11px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 12px 20px; background: none; border: none;
  cursor: pointer; color: var(--muted);
  border-bottom: 2.5px solid transparent; margin-bottom: -1.5px;
  transition: all 0.15s;
}
.tab-btn:hover { color: var(--ink); }
.tab-btn.active { color: var(--ink); border-bottom-color: var(--accent); }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* â”€â”€ Upload zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone {
  border: 2px dashed var(--rule); border-radius: 2px;
  padding: 48px 24px; text-align: center; cursor: pointer;
  transition: all 0.2s; position: relative;
  background: repeating-linear-gradient(
    45deg, transparent, transparent 10px,
    rgba(212,82,10,0.02) 10px, rgba(212,82,10,0.02) 20px
  );
}
.upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(212,82,10,0.04); }
.upload-zone.has-file { border-style: solid; border-color: var(--accent2); background: rgba(26,92,138,0.04); }

.upload-icon {
  width: 52px; height: 52px; margin: 0 auto 16px;
  display: grid; place-items: center;
  border: 2px solid var(--rule); background: var(--paper); position: relative;
}
.upload-icon::before {
  content: ''; position: absolute; inset: -6px;
  border: 1px dashed var(--rule);
}
.upload-icon svg { width: 24px; height: 24px; stroke: var(--muted); }
.upload-title { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
.upload-sub { font-family: var(--mono); font-size: 11px; color: var(--muted); letter-spacing: 0.3px; }

.upload-formats { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
.fmt-tag {
  font-family: var(--mono); font-size: 10px; padding: 3px 8px;
  background: var(--ink); color: var(--paper); letter-spacing: 0.5px;
}

#file-input { display: none; }

.file-selected {
  display: none; margin-top: 20px; padding: 12px 16px;
  border: 1.5px solid var(--accent2); background: rgba(26,92,138,0.06);
  text-align: left; align-items: center; gap: 12px;
}
.file-selected.visible { display: flex; }

.file-icon { width: 32px; height: 36px; background: var(--accent2); display: grid; place-items: center; flex-shrink: 0; }
.file-icon svg { width: 18px; height: 18px; stroke: white; }
.file-name { font-family: var(--mono); font-size: 12px; font-weight: 500; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-size { font-size: 10px; color: var(--muted); margin-top: 2px; }
.file-remove {
  margin-left: auto; flex-shrink: 0;
  background: none; border: 1.5px solid var(--rule);
  width: 28px; height: 28px; cursor: pointer;
  display: grid; place-items: center; color: var(--muted); transition: all 0.15s;
}
.file-remove:hover { border-color: var(--danger); color: var(--danger); }

/* â”€â”€ Form controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label { font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); }

.form-group input,
.form-group select {
  font-family: var(--mono); font-size: 13px; padding: 10px 12px;
  border: 1.5px solid var(--rule); background: var(--paper); color: var(--ink);
  border-radius: 0; outline: none; transition: border-color 0.15s;
  appearance: none; -webkit-appearance: none;
}
.form-group input:focus, .form-group select:focus { border-color: var(--accent2); }

.select-wrap { position: relative; }
.select-wrap::after { content: 'â–¾'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--muted); font-size: 12px; }

.checkbox-row { margin-top: 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
.checkbox-row input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
.checkbox-row span { font-size: 12px; color: var(--muted); font-family: var(--mono); }

/* â”€â”€ Manual JSON input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.manual-help {
  font-family: var(--mono); font-size: 11px; color: var(--muted);
  margin-bottom: 12px; line-height: 1.6;
  padding: 12px; background: rgba(10,15,26,0.03);
  border-left: 3px solid var(--rule);
}
.manual-help code { background: rgba(10,15,26,0.07); padding: 1px 4px; border-radius: 2px; }

#json-input {
  width: 100%; font-family: var(--mono); font-size: 11px;
  padding: 14px; border: 1.5px solid var(--rule);
  background: #fafaf8; color: var(--ink); border-radius: 0;
  outline: none; resize: vertical; min-height: 220px;
  line-height: 1.7; transition: border-color 0.15s;
}
#json-input:focus { border-color: var(--accent2); }

/* â”€â”€ Submit button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-analyse {
  margin-top: 24px; width: 100%; padding: 16px;
  font-family: var(--sans); font-size: 14px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  background: var(--ink); color: var(--paper);
  border: none; cursor: pointer; position: relative; overflow: hidden;
  transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-analyse::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0;
  width: 4px; background: var(--accent);
}
.btn-analyse:hover:not(:disabled) { background: var(--accent); }
.btn-analyse:disabled { opacity: 0.45; cursor: not-allowed; }
.spinner {
  display: none; width: 16px; height: 16px;
  border: 2px solid rgba(245,242,235,0.3); border-top-color: var(--paper);
  border-radius: 50%; animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.btn-analyse.loading .spinner { display: inline-block; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar { display: flex; flex-direction: column; gap: 20px; }

.config-item { padding: 14px 0; border-bottom: 1px solid var(--rule); display: flex; justify-content: space-between; align-items: center; }
.config-item:last-child { border-bottom: none; }
.config-label { font-size: 11px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--muted); }
.config-value { font-family: var(--mono); font-size: 12px; color: var(--ink); }

.rule-list { display: flex; flex-direction: column; gap: 0; max-height: 320px; overflow-y: auto; }
.rule-item {
  padding: 10px 0; border-bottom: 1px solid var(--rule);
  display: grid; grid-template-columns: 1fr auto auto;
  gap: 8px; align-items: center; font-size: 12px;
}
.rule-item:last-child { border-bottom: none; }
.rule-name { color: var(--ink); font-weight: 600; font-size: 11px; }
.rule-badge { font-family: var(--mono); font-size: 9px; padding: 2px 6px; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 500; }
.badge-full    { background: #e8f5e9; color: var(--success); }
.badge-half    { background: #fff3e0; color: var(--warn); }
.badge-excl    { background: #fce4e4; color: var(--danger); }
.badge-cond    { background: #e8eaf6; color: #3949ab; }
.badge-cap     { background: var(--ink); color: var(--paper); }
.item-no-badge {
  display: inline-block; font-family: var(--mono); font-size: 9px;
  font-weight: 700; letter-spacing: 0.5px; padding: 1px 6px;
  background: var(--accent2); color: white; margin-right: 4px;
}
.item-no-badge.small { font-size: 8px; padding: 1px 5px; }
.conc-header { display: flex; align-items: center; flex-wrap: wrap; gap: 4px;
               font-size: 12px; font-weight: 600; margin-bottom: 4px; }
.conc-meta   { display: flex; align-items: center; flex-wrap: wrap; gap: 4px; }
.pnap-ref    { font-family: var(--mono); font-size: 9px; color: var(--muted);
               margin-top: 2px; letter-spacing: 0.3px; }
.concession-tag.bp     { background: #e0f0ff; color: #1a5c8a; }
.concession-tag.prereq { background: #f5f0e0; color: #7a5800; }
.concession-tag.warn   { background: #fce4e4; color: var(--danger); font-weight: 700; }
.conc-exceeded { background: #fff5f5 !important; }

/* â”€â”€ Results panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#results { display: none; }
#results.visible { display: block; }

.results-grid {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 1.5px; background: var(--rule); margin-bottom: 24px;
}

.metric-cell { background: var(--card-bg); padding: 20px 24px; position: relative; overflow: hidden; }
.metric-cell::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
.metric-cell.gfa::before    { background: var(--accent2); }
.metric-cell.nofa::before   { background: var(--accent); }
.metric-cell.ratio::before  { background: var(--success); }

.metric-label { font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.metric-value { font-size: 32px; font-weight: 800; letter-spacing: -1.5px; line-height: 1; }
.metric-unit { font-family: var(--mono); font-size: 11px; color: var(--muted); margin-top: 4px; }

/* â”€â”€ Cap bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cap-section { margin-top: 0; padding: 20px; border: 1.5px solid var(--rule); background: var(--card-bg); margin-bottom: 0; }
.cap-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; }
.cap-title { font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); }
.cap-pct { font-family: var(--mono); font-size: 14px; font-weight: 500; }
.cap-pct.over { color: var(--danger); }
.cap-track { height: 8px; background: var(--rule); position: relative; }
.cap-fill { height: 100%; background: var(--accent2); transition: width 1s cubic-bezier(0.16, 1, 0.3, 1); position: relative; }
.cap-fill.over { background: var(--danger); }
.cap-fill::after { content: ''; position: absolute; right: 0; top: -3px; bottom: -3px; width: 2px; background: inherit; }
.cap-sublabel { font-family: var(--mono); font-size: 10px; color: var(--muted); margin-top: 8px; display: flex; justify-content: space-between; }

/* â”€â”€ Concessions panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.concessions-grid { display: flex; flex-direction: column; gap: 1.5px; background: var(--rule); }
.concession-row {
  background: var(--card-bg); padding: 12px 16px;
  display: grid; grid-template-columns: 1fr auto auto;
  gap: 12px; align-items: center;
}
.concession-name { font-size: 12px; font-weight: 600; }
.concession-area { font-family: var(--mono); font-size: 12px; text-align: right; }
.concession-tag {
  font-family: var(--mono); font-size: 9px; padding: 2px 7px;
  letter-spacing: 0.5px; text-transform: uppercase;
}
.concession-tag.cap  { background: rgba(168,80,0,0.1); color: var(--warn); border: 1px solid rgba(168,80,0,0.3); }
.concession-tag.free { background: rgba(42,107,58,0.1); color: var(--success); border: 1px solid rgba(42,107,58,0.3); }

/* â”€â”€ Warnings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.warnings-list { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
.warning-item {
  padding: 10px 14px; background: rgba(168,80,0,0.06);
  border-left: 3px solid var(--warn);
  font-size: 11px; font-family: var(--mono); color: var(--warn); line-height: 1.5;
}
.warning-item.danger { background: rgba(176,26,26,0.06); border-left-color: var(--danger); color: var(--danger); }

/* â”€â”€ Room table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.room-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.room-table th {
  font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
  color: var(--muted); padding: 8px 12px; text-align: left;
  background: var(--paper); border-bottom: 2px solid var(--ink);
  position: sticky; top: 0; z-index: 1;
}
.room-table td { padding: 9px 12px; border-bottom: 1px solid var(--rule); font-family: var(--mono); font-size: 11px; }
.room-table tr:last-child td { border-bottom: none; }
.room-table tr:hover td { background: rgba(212,82,10,0.03); }
.td-label { font-weight: 600; }
.td-floor { color: var(--muted); }
.td-rule { text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; font-weight: 600; }
.td-rule.full  { color: var(--success); }
.td-rule.excl  { color: var(--danger); }
.td-rule.half  { color: var(--warn); }
.td-rule.cond  { color: #3949ab; }
.td-warn { color: var(--danger); font-size: 10px; }
.table-scroll { max-height: 360px; overflow-y: auto; }

/* â”€â”€ Download button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-download {
  margin-top: 20px; width: 100%; padding: 14px;
  font-family: var(--sans); font-size: 13px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  background: transparent; color: var(--accent2);
  border: 2px solid var(--accent2); cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  transition: all 0.2s; text-decoration: none;
}
.btn-download:hover { background: var(--accent2); color: var(--paper); }
.btn-download-pdf { color: var(--accent); border-color: var(--accent); margin-top: 8px; }
.btn-download-pdf:hover { background: var(--accent); color: var(--paper); }
.btn-download svg { width: 16px; height: 16px; stroke: currentColor; }

/* â”€â”€ Error state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.error-box { display: none; margin-top: 16px; padding: 16px; border: 1.5px solid var(--danger); background: rgba(176,26,26,0.05); }
.error-box.visible { display: block; }
.error-box p { font-family: var(--mono); font-size: 12px; color: var(--danger); line-height: 1.5; }

/* â”€â”€ Results section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title {
  font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
  text-transform: uppercase; color: var(--muted);
  margin-bottom: 12px; margin-top: 24px;
  display: flex; align-items: center; gap: 10px;
}
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--rule); }

/* â”€â”€ Demo badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.demo-badge {
  font-family: var(--mono); font-size: 9px; padding: 2px 8px;
  background: var(--accent); color: var(--paper);
  letter-spacing: 1px; text-transform: uppercase;
  display: inline-block; vertical-align: middle; margin-left: 8px;
}

/* â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-tip] { position: relative; cursor: help; }
[data-tip]::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  background: var(--ink); color: var(--paper);
  font-family: var(--mono); font-size: 10px; padding: 6px 10px;
  white-space: nowrap; pointer-events: none; opacity: 0;
  transition: opacity 0.15s; z-index: 100;
}
[data-tip]:hover::after { opacity: 1; }

/* â”€â”€ Scale Confirm Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 100;
  background: rgba(10,15,26,0.6);
  backdrop-filter: blur(2px);
  align-items: center; justify-content: center;
}
.modal-overlay.visible { display: flex; }

.modal {
  background: var(--card-bg);
  border: 2px solid var(--ink);
  width: 100%; max-width: 440px;
  margin: 24px;
  animation: slideIn 0.25s cubic-bezier(0.16,1,0.3,1);
}

.modal-header {
  background: var(--ink); color: var(--paper);
  padding: 16px 24px;
  display: flex; align-items: center; gap: 12px;
}
.modal-header h3 { font-size: 14px; font-weight: 700; letter-spacing: 0.5px; }
.modal-icon {
  width: 32px; height: 32px; background: var(--accent);
  display: grid; place-items: center; flex-shrink: 0; font-size: 16px;
}

.modal-body { padding: 24px; }

.modal-desc {
  font-family: var(--mono); font-size: 12px; color: var(--muted);
  line-height: 1.7; margin-bottom: 20px;
}
.modal-desc strong { color: var(--ink); }

.modal-detected {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; margin-bottom: 20px;
  border: 1.5px solid var(--rule); background: var(--paper);
}
.modal-detected-label {
  font-size: 11px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase; color: var(--muted); flex: 1;
}
.modal-detected-value {
  font-family: var(--mono); font-size: 20px; font-weight: 500;
  color: var(--ink);
}
.modal-confidence {
  font-family: var(--mono); font-size: 9px; padding: 2px 8px;
  letter-spacing: 1px; text-transform: uppercase;
}
.modal-confidence.high   { background: #e8f5e9; color: var(--success); }
.modal-confidence.medium { background: #fff3e0; color: var(--warn); }
.modal-confidence.low    { background: #fce4e4; color: var(--danger); }

.modal-override {
  margin-bottom: 8px;
}
.modal-override label {
  font-size: 11px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase; color: var(--muted);
  display: block; margin-bottom: 6px;
}
.modal-override-row {
  display: flex; gap: 8px; align-items: center;
}
.modal-override-row span {
  font-family: var(--mono); font-size: 13px; color: var(--muted);
}
#modal-scale-input {
  flex: 1; font-family: var(--mono); font-size: 14px;
  padding: 10px 12px; border: 1.5px solid var(--rule);
  background: var(--paper); color: var(--ink);
  outline: none; transition: border-color 0.15s;
}
#modal-scale-input:focus { border-color: var(--accent2); }

.modal-footer {
  padding: 16px 24px;
  border-top: 1.5px solid var(--rule);
  display: flex; gap: 10px; justify-content: flex-end;
}
.btn-modal-confirm {
  font-family: var(--sans); font-size: 12px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 10px 24px; background: var(--ink); color: var(--paper);
  border: none; cursor: pointer; transition: background 0.15s;
}
.btn-modal-confirm:hover { background: var(--accent); }
.btn-modal-cancel {
  font-family: var(--sans); font-size: 12px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 10px 20px; background: transparent; color: var(--muted);
  border: 1.5px solid var(--rule); cursor: pointer; transition: all 0.15s;
}
.btn-modal-cancel:hover { border-color: var(--ink); color: var(--ink); }

/* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer {
  position: relative; z-index: 1;
  border-top: 1.5px solid var(--rule); padding: 20px 48px;
  display: flex; justify-content: space-between; align-items: center;
}
.footer-left { font-family: var(--mono); font-size: 10px; color: var(--muted); letter-spacing: 0.5px; }
.footer-right { font-family: var(--mono); font-size: 10px; color: var(--muted); }

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
.animate-in { animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

@keyframes countUp { from { opacity: 0; } to { opacity: 1; } }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 900px) {
  header, main, footer { padding-left: 24px; padding-right: 24px; }
  .demo-banner { padding-left: 24px; padding-right: 24px; flex-direction: column; align-items: flex-start; }
  .layout { grid-template-columns: 1fr; }
  .results-grid { grid-template-columns: 1fr 1fr; }
  .page-title { flex-direction: column; gap: 12px; align-items: flex-start; }
}
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
  <div class="header-logo">
    <div class="logo-mark">
      <span></span><span></span>
      <span></span><span></span>
    </div>
    <div class="logo-text">Area<em>Calc</em> HK</div>
  </div>
  <div class="header-meta">
    <div class="header-badge">
      <span class="status-dot" id="api-dot"></span><span id="api-status">Connectingâ€¦</span><br>
      PNAP APP-2 & APP-151
    </div>
    <div class="header-badge">
      Spec v1.1<br>
      Rev. Jul 2025
    </div>
  </div>
</header>

<!-- â”€â”€ Demo Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="demo-banner" id="demo-banner">
  <div class="demo-banner-text">
    <span>Demo</span>
    No floor plan? Try with sample residential data â€” Tower A, 3/F
  </div>
  <div class="demo-banner-actions">
    <button class="btn-load-demo" onclick="loadDemo()">Load Sample Data â†’</button>
    <button class="btn-dismiss-demo" onclick="dismissBanner()">dismiss</button>
  </div>
</div>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main>

  <div class="page-title">
    <h1>
      Floor Plan<br>
      <span>Area Calculator</span>
    </h1>
    <div class="spec-tag">
      <strong>GFA Â· UFA Â· NOFA</strong><br>
      Hong Kong Buildings Ordinance<br>
      B(P)R 23 Â· PNAP APP-2 Â· APP-151
    </div>
  </div>

  <div class="layout">

    <!-- â”€â”€ Left: Upload + Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div>

      <!-- Upload card with tabs -->
      <div class="card">
        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('upload',this)">Upload File</button>
          <button class="tab-btn" onclick="switchTab('json',this)">JSON / Manual</button>
        </div>

        <!-- TAB: Upload -->
        <div class="tab-panel active" id="tab-upload">
          <div class="card-body">

            <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
              <input type="file" id="file-input" accept=".dxf,.pdf,.jpg,.jpeg,.png,.tif,.tiff,.bmp"/>
              <div class="upload-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
              <div class="upload-title">Drop floor plan here</div>
              <div class="upload-sub">or click to browse</div>
              <div class="upload-formats">
                <span class="fmt-tag">DXF</span>
                <span class="fmt-tag">PDF</span>
                <span class="fmt-tag">JPG</span>
                <span class="fmt-tag">PNG</span>
                <span class="fmt-tag">TIF</span>
              </div>
            </div>

            <div class="file-selected" id="file-selected">
              <div class="file-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
              </div>
              <div>
                <div class="file-name" id="file-name-text"></div>
                <div class="file-size" id="file-size-text"></div>
              </div>
              <button class="file-remove" id="file-remove" title="Remove file">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Building Type</label>
                <div class="select-wrap">
                  <select id="building-type">
                    <option value="residential">Residential</option>
                    <option value="non_domestic">Non-Domestic</option>
                    <option value="composite">Composite</option>
                    <option value="hotel">Hotel</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Floor Label</label>
                <input type="text" id="floor-label" value="3/F" placeholder="e.g. 3/F"/>
              </div>
              <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="project-name" placeholder="Tower A"/>
              </div>
              <div class="form-group">
                <label>Drawing Scale</label>
                <div class="select-wrap">
                  <select id="draw-scale" onchange="handleScaleChange(this)">
                    <option value="20">1:20</option>
                    <option value="50">1:50</option>
                    <option value="100" selected>1:100</option>
                    <option value="150">1:150</option>
                    <option value="200">1:200</option>
                    <option value="250">1:250</option>
                    <option value="500">1:500</option>
                    <option value="1000">1:1000</option>
                    <option value="custom">Customâ€¦</option>
                  </select>
                </div>
                <div id="custom-scale-wrap" style="display:none;margin-top:6px;position:relative;">
                  <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-family:var(--mono);font-size:12px;color:var(--muted);pointer-events:none;">1:</span>
                  <input type="number" id="custom-scale" min="1" max="9999" placeholder="e.g. 125"
                    style="padding-left:28px;width:100%;"
                    oninput="validateCustomScale(this)"/>
                </div>
              </div>
            </div>

            <label class="checkbox-row">
              <input type="checkbox" id="export-excel" checked/>
              <span>Generate Excel area schedule (.xlsx)</span>
            </label>

            <label class="checkbox-row">
              <input type="checkbox" id="annotate-pdf" checked/>
              <span>Generate annotated floor plan PDF</span>
            </label>

            <div class="error-box" id="error-box"><p id="error-text"></p></div>

            <button class="btn-analyse" id="btn-analyse" disabled onclick="runAnalyse()">
              Analyse Floor Plan
              <span class="spinner"></span>
            </button>

          </div>
        </div>

        <!-- TAB: JSON / Manual -->
        <div class="tab-panel" id="tab-json">
          <div class="card-body">
            <div class="manual-help">
              Paste a JSON array of rooms. Each room needs <code>label</code> and <code>area_m2</code>. Optionally add <code>floor</code> and <code>id</code>.<br><br>
              <strong>Tip:</strong> Click <strong>Load Sample Data</strong> in the banner above to see an example.
            </div>
            <textarea id="json-input" spellcheck="false" placeholder='[
  {"label": "Master Bedroom", "area_m2": 14.2, "floor": "3/F"},
  {"label": "Balcony",        "area_m2": 4.5,  "floor": "3/F"},
  {"label": "Bathroom",       "area_m2": 5.0,  "floor": "3/F"},
  {"label": "Lift Shaft",     "area_m2": 3.0,  "floor": "3/F"}
]'></textarea>
            <div class="form-row" style="margin-top:16px;">
              <div class="form-group">
                <label>Building Type</label>
                <div class="select-wrap">
                  <select id="json-building-type">
                    <option value="residential">Residential</option>
                    <option value="non_domestic">Non-Domestic</option>
                    <option value="composite">Composite</option>
                    <option value="hotel">Hotel</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="json-project-name" placeholder="Tower A"/>
              </div>
            </div>
            <label class="checkbox-row">
              <input type="checkbox" id="json-export-excel" checked/>
              <span>Generate Excel area schedule (.xlsx)</span>
            </label>
            <div class="error-box" id="json-error-box"><p id="json-error-text"></p></div>
            <button class="btn-analyse" id="btn-classify" onclick="runClassify()" style="margin-top:24px;">
              Classify Rooms
              <span class="spinner"></span>
            </button>
          </div>
        </div>

      </div>

      <!-- Results (hidden until analysis) -->
      <div id="results" style="margin-top:32px;">
        <div class="card animate-in">
          <div class="card-header">
            <h2>Area Report <span id="demo-label"></span></h2>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
              <span class="card-label" id="results-meta"></span>
              <span id="scale-info" style="display:none;font-family:var(--mono);font-size:10px;color:var(--accent2);"></span>
            </div>
          </div>
          <div class="card-body">

            <!-- Key metrics -->
            <div class="results-grid">
              <div class="metric-cell gfa" data-tip="Gross Floor Area per PNAP APP-2">
                <div class="metric-label">Gross Floor Area</div>
                <div class="metric-value" id="m-gfa">â€”</div>
                <div class="metric-unit">mÂ²</div>
              </div>
              <div class="metric-cell nofa" data-tip="Net Operational Floor Area">
                <div class="metric-label">Net Op. Floor Area</div>
                <div class="metric-value" id="m-nofa">â€”</div>
                <div class="metric-unit">mÂ²</div>
              </div>
              <div class="metric-cell ratio" data-tip="NOFA Ã· GFA â€” higher is more efficient">
                <div class="metric-label">NOFA / GFA</div>
                <div class="metric-value" id="m-ratio">â€”</div>
                <div class="metric-unit">efficiency ratio</div>
              </div>
            </div>

            <!-- APP-151 cap -->
            <div class="section-title">APP-151 Concession Cap</div>
            <div class="cap-section">
              <div class="cap-header">
                <div class="cap-title" data-tip="Must not exceed 10% of total GFA">10% Cap Utilisation</div>
                <div class="cap-pct" id="cap-pct">0%</div>
              </div>
              <div class="cap-track">
                <div class="cap-fill" id="cap-fill" style="width:0%"></div>
              </div>
              <div class="cap-sublabel">
                <span id="cap-used-label">0 mÂ² used</span>
                <span id="cap-limit-label">limit: 0 mÂ²</span>
              </div>
            </div>

            <!-- Concessions breakdown -->
            <div id="concessions-section" style="display:none">
              <div class="section-title">Concessions Breakdown</div>
              <div class="concessions-grid" id="concessions-grid"></div>
            </div>

            <!-- Warnings -->
            <div class="warnings-list" id="warnings-list"></div>

            <!-- Room table -->
            <div class="section-title">Room Schedule</div>
            <div class="table-scroll">
              <table class="room-table">
                <thead>
                  <tr>
                    <th>Room</th>
                    <th>Floor</th>
                    <th>Area mÂ²</th>
                    <th>GFA Rule</th>
                    <th>GFA mÂ²</th>
                    <th>NOFA mÂ²</th>
                    <th>Concession</th>
                  </tr>
                </thead>
                <tbody id="room-tbody"></tbody>
              </table>
            </div>

            <!-- Download Excel -->
            <a class="btn-download" id="btn-download" href="#" style="display:none">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Download Excel Area Schedule
            </a>

            <!-- Download Annotated PDF -->
            <a class="btn-download btn-download-pdf" id="btn-download-pdf" href="#" style="display:none">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
                <polyline points="7 10 12 15 17 10"/>
              </svg>
              Download Annotated Floor Plan PDF
            </a>

          </div>
        </div>
      </div>

    </div>

    <!-- â”€â”€ Right: Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="sidebar">

      <!-- Classification rules reference -->
      <div class="card">
        <div class="card-header">
          <h2>Classification Rules</h2>
          <span class="card-label">APP-2 & APP-151</span>
        </div>
        <div class="card-body" style="padding-top:8px;">
          <div class="rule-list" id="rule-list">
            <div style="font-family:var(--mono);font-size:11px;color:var(--muted);padding:12px 0;">
              Loading rulesâ€¦
            </div>
          </div>
        </div>
      </div>

      <!-- Building type info -->
      <div class="card">
        <div class="card-header">
          <h2>Building Type Notes</h2>
          <span class="card-label">APP-151</span>
        </div>
        <div class="card-body">
          <div class="config-item">
            <div class="config-label">Balcony Rule</div>
            <div class="config-value">50% â†’ GFA</div>
          </div>
          <div class="config-item">
            <div class="config-label">10% Cap</div>
            <div class="config-value">Non-mandatory items</div>
          </div>
          <div class="config-item">
            <div class="config-label">BEAM Plus</div>
            <div class="config-value">Most concessions</div>
          </div>
          <div class="config-item">
            <div class="config-label">Spec Version</div>
            <div class="config-value">APP-151 Jul 2025</div>
          </div>
          <div class="config-item" style="border:none">
            <div class="config-label">Pending Review</div>
            <div class="config-value" style="color:var(--warn)">AP/QS sign-off</div>
          </div>
        </div>
      </div>

      <!-- Quick help -->
      <div class="card">
        <div class="card-header">
          <h2>Quick Help</h2>
          <span class="card-label">GFA Rules</span>
        </div>
        <div class="card-body">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <span class="rule-badge badge-full" style="flex-shrink:0">full</span>
              <span style="font-size:11px;color:var(--muted);font-family:var(--mono)">Counts 100% towards GFA</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <span class="rule-badge badge-half" style="flex-shrink:0">half</span>
              <span style="font-size:11px;color:var(--muted);font-family:var(--mono)">Counts 50% towards GFA</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <span class="rule-badge badge-excl" style="flex-shrink:0">excl</span>
              <span style="font-size:11px;color:var(--muted);font-family:var(--mono)">Excluded â€” no GFA impact</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <span class="rule-badge badge-cond" style="flex-shrink:0">cond</span>
              <span style="font-size:11px;color:var(--muted);font-family:var(--mono)">Conditional concession</span>
            </div>
          </div>
          <div style="margin-top:16px;padding:12px;background:rgba(10,15,26,0.03);border-left:3px solid var(--rule);">
            <div style="font-family:var(--mono);font-size:10px;color:var(--muted);line-height:1.7;">
              The APP-151 10% cap limits total non-mandatory concessions to 10% of the building's GFA. Exceeding this requires BD approval.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- â”€â”€ Scale Confirm Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="scale-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">ğŸ“</div>
      <h3>Confirm Drawing Scale</h3>
    </div>
    <div class="modal-body">
      <p class="modal-desc" id="modal-desc">
        We detected a drawing scale from your file. Please confirm it is correct before proceeding.
      </p>
      <div class="modal-detected">
        <div class="modal-detected-label">Detected Scale</div>
        <div class="modal-detected-value" id="modal-scale-display">1:100</div>
        <span class="modal-confidence" id="modal-confidence-badge">â€”</span>
      </div>
      <div class="modal-override">
        <label>Override Scale (if incorrect)</label>
        <div class="modal-override-row">
          <span>1 :</span>
          <input type="number" id="modal-scale-input" min="1" max="9999" placeholder="e.g. 100"/>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="cancelModal()">Cancel Upload</button>
      <button class="btn-modal-confirm" onclick="confirmScale()">Confirm & Analyse â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<footer>
  <div class="footer-left">
    AreaCalc HK Â· PNAP APP-2 & APP-151 (Rev. Jul 2025) Â· v1.0.0
  </div>
  <div class="footer-right">
    Rules pending AP/QS confirmation Â· Not for BD submission without sign-off
  </div>
</footer>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = window.location.hostname === 'localhost'
  ? 'http://localhost:5000'
  : window.location.origin;

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone     = document.getElementById('drop-zone');
const fileInput    = document.getElementById('file-input');
const fileSelected = document.getElementById('file-selected');
const fileNameEl   = document.getElementById('file-name-text');
const fileSizeEl   = document.getElementById('file-size-text');
const fileRemove   = document.getElementById('file-remove');
const btnAnalyse   = document.getElementById('btn-analyse');
const btnClassify  = document.getElementById('btn-classify');
const resultsEl    = document.getElementById('results');
const ruleList     = document.getElementById('rule-list');

let selectedFile = null;
let isDemoResult = false;

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// â”€â”€ File helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

function setFile(file) {
  selectedFile = file;
  fileNameEl.textContent = file.name;
  fileSizeEl.textContent = formatBytes(file.size);
  fileSelected.classList.add('visible');
  dropZone.classList.add('has-file');
  btnAnalyse.disabled = false;
  clearError('error-box');
}

function clearFile() {
  selectedFile = null;
  fileInput.value = '';
  fileSelected.classList.remove('visible');
  dropZone.classList.remove('has-file');
  btnAnalyse.disabled = true;
}

function showError(boxId, msg) {
  document.getElementById(boxId.replace('-box','') + '-box') || document.getElementById(boxId);
  const box  = document.getElementById(boxId);
  const text = document.getElementById(boxId.replace('box','text'));
  if (box && text) { text.textContent = msg; box.classList.add('visible'); }
}
function clearError(boxId) {
  const box = document.getElementById(boxId);
  if (box) box.classList.remove('visible');
}

// â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) setFile(file);
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) setFile(e.target.files[0]); });
fileRemove.addEventListener('click', e => { e.stopPropagation(); clearFile(); });

// â”€â”€ API health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkHealth() {
  const dot    = document.getElementById('api-dot');
  const status = document.getElementById('api-status');
  try {
    const res = await fetch(`${API_BASE}/api/health`, { signal: AbortSignal.timeout(5000) });
    if (res.ok) {
      dot.classList.remove('offline');
      status.textContent = 'API Connected';
    } else {
      throw new Error();
    }
  } catch {
    dot.classList.add('offline');
    status.textContent = 'API Offline';
  }
}

// â”€â”€ Load rules from API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRules() {
  try {
    const res  = await fetch(`${API_BASE}/api/rules`, { signal: AbortSignal.timeout(5000) });
    const data = await res.json();
    renderRules(data.rules);
  } catch {
    ruleList.innerHTML = '<div style="font-family:var(--mono);font-size:11px;color:var(--muted);padding:8px 0;">API offline â€” rules unavailable</div>';
  }
}

function renderRules(rules) {
  const seen = new Set();
  ruleList.innerHTML = rules.map(r => {
    if (seen.has(r.label)) return '';
    seen.add(r.label);
    const gfaClass = r.gfa_rule === 'full' ? 'full'
                   : r.gfa_rule === 'half' ? 'half'
                   : r.gfa_rule === 'excluded' ? 'excl' : 'cond';
    const capBadge = r.subject_to_cap ? `<span class="rule-badge badge-cap">Cap</span>` : '';
    return `
      <div class="rule-item">
        <div class="rule-name">${r.label}</div>
        <span class="rule-badge badge-${gfaClass}">${r.gfa_rule}</span>
        ${capBadge}
      </div>`;
  }).join('');
}

// â”€â”€ Analyse (file upload) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pendingAnalyseParams = null;  // saved while modal is open

async function runAnalyse() {
  if (!selectedFile) return;

  const buildingType = document.getElementById('building-type').value;
  const floorLabel   = document.getElementById('floor-label').value || 'â€”';
  const projectName  = document.getElementById('project-name').value || 'Floor Plan';
  const userScale    = getScale();
  const exportExcel  = document.getElementById('export-excel').checked;

  if (!userScale) { showError('error-box', 'Please enter a valid drawing scale (e.g. 1:125).'); return; }

  btnAnalyse.disabled = true;
  btnAnalyse.classList.add('loading');
  btnAnalyse.textContent = 'Detecting scaleâ€¦';
  clearError('error-box');
  resultsEl.classList.remove('visible');
  isDemoResult = false;

  // â”€â”€ Step 1: pre-flight scale detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let detectedScale = userScale;
  let detectionMethod = 'user_input';

  try {
    const preForm = new FormData();
    preForm.append('file', selectedFile);
    preForm.append('scale', userScale);
    const preRes  = await fetch(`${API_BASE}/api/detect-scale`, { method: 'POST', body: preForm });
    const preData = await preRes.json();

    if (preRes.ok && preData.success) {
      detectedScale   = preData.scale_to_use;
      detectionMethod = preData.detection_method;

      // Show confirmation modal
      _pendingAnalyseParams = { buildingType, floorLabel, projectName, exportExcel };
      showScaleModal(detectedScale, detectionMethod, preData.confidence, userScale);

      // Modal will call confirmScale() to continue â€” stop here
      btnAnalyse.disabled = false;
      btnAnalyse.classList.remove('loading');
      btnAnalyse.textContent = '';
      btnAnalyse.innerHTML = 'Analyse Floor Plan <span class="spinner"></span>';
      return;
    }
  } catch (e) {
    // Pre-flight failed â€” proceed with user scale directly
    logger.debug?.('Pre-flight detect-scale failed, using user scale');
  }

  // â”€â”€ Step 2: if pre-flight failed, run directly with user scale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  btnAnalyse.innerHTML = 'Analyse Floor Plan <span class="spinner"></span>';
  await _doAnalyse(buildingType, floorLabel, projectName, userScale, exportExcel);
}

function showScaleModal(detectedScale, method, confidence, userScale) {
  const modal      = document.getElementById('scale-modal');
  const display    = document.getElementById('modal-scale-display');
  const badge      = document.getElementById('modal-confidence-badge');
  const desc       = document.getElementById('modal-desc');
  const input      = document.getElementById('modal-scale-input');

  display.textContent = `1:${detectedScale}`;
  input.value         = detectedScale;
  input.placeholder   = detectedScale;

  // Confidence badge
  badge.className  = `modal-confidence ${confidence}`;
  badge.textContent = confidence === 'high' ? 'High confidence'
                    : confidence === 'medium' ? 'Medium confidence'
                    : 'Low confidence';

  // Description
  const methodLabel = method === 'text'       ? 'title block text (e.g. "SCALE 1:100")'
                    : method === 'scale_bar'   ? 'scale bar image analysis'
                    : 'your manual selection';
  desc.innerHTML = `Scale <strong>1:${detectedScale}</strong> was detected from <strong>${methodLabel}</strong>.`
    + (userScale !== detectedScale
      ? ` Your manual selection was 1:${userScale}.`
      : '')
    + ` Please confirm or enter a different value below.`;

  modal.classList.add('visible');
  input.focus();
  input.select();
}

function cancelModal() {
  document.getElementById('scale-modal').classList.remove('visible');
  _pendingAnalyseParams = null;
}

async function confirmScale() {
  const input  = document.getElementById('modal-scale-input');
  const scale  = parseInt(input.value, 10);
  if (!scale || scale < 1 || scale > 9999) {
    input.style.borderColor = 'var(--danger)';
    input.focus();
    return;
  }
  input.style.borderColor = '';
  document.getElementById('scale-modal').classList.remove('visible');

  if (!_pendingAnalyseParams) return;
  const { buildingType, floorLabel, projectName, exportExcel } = _pendingAnalyseParams;
  _pendingAnalyseParams = null;

  btnAnalyse.disabled = true;
  btnAnalyse.classList.add('loading');
  await _doAnalyse(buildingType, floorLabel, projectName, scale, exportExcel);
}

async function _doAnalyse(buildingType, floorLabel, projectName, scale, exportExcel) {
  const annotatePdf = document.getElementById('annotate-pdf')?.checked ?? false;

  const form = new FormData();
  form.append('file',          selectedFile);
  form.append('building_type', buildingType);
  form.append('floor',         floorLabel);
  form.append('project_name',  projectName);
  form.append('scale',         scale);
  form.append('export_excel',  exportExcel ? 'true' : 'false');

  try {
    const res  = await fetch(`${API_BASE}/api/analyse`, { method: 'POST', body: form });
    const data = await res.json();
    if (!res.ok || !data.success) {
      showError('error-box', data.error || `Server error (${res.status})`);
      return;
    }

    // If annotate requested, fire off annotate call with same file
    if (annotatePdf && selectedFile && selectedFile.name.toLowerCase().endsWith('.pdf')) {
      renderResults(data, false);
      // Kick off annotation in background
      _doAnnotate(buildingType, floorLabel, projectName, scale, data.rooms);
    } else {
      renderResults(data, false);
    }

  } catch (e) {
    showError('error-box', `Could not reach API at ${API_BASE}. Make sure the backend is running.`);
  } finally {
    btnAnalyse.disabled = false;
    btnAnalyse.classList.remove('loading');
  }
}

async function _doAnnotate(buildingType, floorLabel, projectName, scale, rooms) {
  const dlBtn = document.getElementById('btn-download-pdf');
  dlBtn.style.display = 'flex';
  dlBtn.textContent   = 'â³ Generating annotated PDFâ€¦';
  dlBtn.removeAttribute('href');

  try {
    const form = new FormData();
    form.append('file',          selectedFile);
    form.append('building_type', buildingType);
    form.append('floor',         floorLabel);
    form.append('project_name',  projectName);
    form.append('scale',         scale);
    form.append('rooms',         JSON.stringify(rooms || []));

    const res  = await fetch(`${API_BASE}/api/annotate`, { method: 'POST', body: form });
    const data = await res.json();

    if (res.ok && data.success && data.annotated_pdf_url) {
      dlBtn.href = `${API_BASE}${data.annotated_pdf_url}`;
      dlBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;stroke:currentColor">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
          <polyline points="7 10 12 15 17 10"/>
        </svg>
        Download Annotated Floor Plan PDF`;
    } else {
      dlBtn.textContent = 'âš  Annotation failed â€” ' + (data.error || 'unknown error');
      dlBtn.style.color = 'var(--danger)';
      dlBtn.style.borderColor = 'var(--danger)';
    }
  } catch (e) {
    dlBtn.textContent = 'âš  Annotation request failed';
    dlBtn.style.color = 'var(--danger)';
    dlBtn.style.borderColor = 'var(--danger)';
  }
}

// â”€â”€ Classify (JSON input) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runClassify() {
  const raw = document.getElementById('json-input').value.trim();
  if (!raw) { showError('json-error-box', 'Please enter room data as JSON.'); return; }

  let rooms;
  try { rooms = JSON.parse(raw); }
  catch (e) { showError('json-error-box', `JSON parse error: ${e.message}`); return; }

  const buildingType = document.getElementById('json-building-type').value;
  const projectName  = document.getElementById('json-project-name').value || 'Floor Plan';
  const exportExcel  = document.getElementById('json-export-excel').checked;

  btnClassify.disabled = true;
  btnClassify.classList.add('loading');
  clearError('json-error-box');
  resultsEl.classList.remove('visible');

  try {
    const res = await fetch(`${API_BASE}/api/classify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ building_type: buildingType, project_name: projectName, export_excel: exportExcel, rooms }),
    });
    const data = await res.json();
    if (!res.ok || !data.success) {
      showError('json-error-box', data.error || `Server error (${res.status})`);
    } else {
      renderResults(data, isDemoResult);
    }
  } catch (e) {
    showError('json-error-box', `Could not reach API at ${API_BASE}. Make sure the backend is running.`);
  } finally {
    btnClassify.disabled = false;
    btnClassify.classList.remove('loading');
  }
}

// â”€â”€ Demo data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_ROOMS = [
  {"label": "Living / Dining",    "area_m2": 28.4, "floor": "3/F"},
  {"label": "Master Bedroom",     "area_m2": 16.2, "floor": "3/F"},
  {"label": "Bedroom 2",          "area_m2": 11.5, "floor": "3/F"},
  {"label": "Kitchen",            "area_m2": 9.8,  "floor": "3/F"},
  {"label": "Master Bathroom",    "area_m2": 6.2,  "floor": "3/F"},
  {"label": "Bathroom",           "area_m2": 4.8,  "floor": "3/F"},
  {"label": "Balcony",            "area_m2": 7.5,  "floor": "3/F"},
  {"label": "Utility Platform",   "area_m2": 2.1,  "floor": "3/F"},
  {"label": "Entrance Lobby",     "area_m2": 4.4,  "floor": "3/F"},
  {"label": "Lift Lobby",         "area_m2": 8.6,  "floor": "3/F"},
  {"label": "Staircase",          "area_m2": 6.3,  "floor": "3/F"},
  {"label": "Lift Shaft",         "area_m2": 3.2,  "floor": "3/F"},
  {"label": "Plant Room",         "area_m2": 5.1,  "floor": "3/F"},
  {"label": "Mail Room",          "area_m2": 3.8,  "floor": "3/F"},
];

function loadDemo() {
  // Switch to JSON tab
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn')[1].classList.add('active');
  document.getElementById('tab-json').classList.add('active');

  document.getElementById('json-input').value = JSON.stringify(DEMO_ROOMS, null, 2);
  document.getElementById('json-project-name').value = 'Tower A';
  isDemoResult = true;

  dismissBanner();

  // Auto-run
  setTimeout(() => runClassify(), 100);
}

function dismissBanner() {
  document.getElementById('demo-banner').style.display = 'none';
}

// â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateNumber(el, target, decimals = 1, suffix = '') {
  const start = performance.now();
  const duration = 800;
  const startVal = 0;
  function step(now) {
    const t = Math.min((now - start) / duration, 1);
    const ease = 1 - Math.pow(1 - t, 3);
    const val = startVal + (target - startVal) * ease;
    el.textContent = val.toFixed(decimals) + suffix;
    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function renderResults(data, isDemo) {
  // Demo badge
  document.getElementById('demo-label').innerHTML = isDemo
    ? '<span class="demo-badge">Demo</span>' : '';

  // Meta
  document.getElementById('results-meta').textContent =
    `${data.rooms_parsed} rooms Â· ${data.building_type} Â· ${data.floor || data.project_name || 'â€”'}`;

  // Show scale info if auto-detected
  const scaleInfo = document.getElementById('scale-info');
  if (data.scale_used) {
    const src = data.scale_source === 'scale_bar_detected' ? 'ğŸ“ auto-detected from scale bar' : 'user input';
    scaleInfo.textContent = `Scale 1:${data.scale_used} (${src})`;
    scaleInfo.style.display = 'block';
  } else {
    scaleInfo.style.display = 'none';
  }

  // Metrics â€” animated
  const gfaEl   = document.getElementById('m-gfa');
  const nofaEl  = document.getElementById('m-nofa');
  const ratioEl = document.getElementById('m-ratio');
  animateNumber(gfaEl,  data.total_gfa_m2,  1);
  animateNumber(nofaEl, data.total_nofa_m2, 1);

  const ratioPct = (data.nofa_gfa_ratio * 100);
  animateNumber(ratioEl, ratioPct, 1, '%');

  // Cap bar â€” animated
  const capPct   = Math.min(data.cap_utilisation_pct, 100);
  const capEl    = document.getElementById('cap-fill');
  const capText  = document.getElementById('cap-pct');
  capEl.style.width = '0%';
  setTimeout(() => { capEl.style.width = capPct + '%'; }, 100);
  capText.textContent = data.cap_utilisation_pct.toFixed(1) + '%';
  capEl.classList.toggle('over', data.cap_exceeded);
  capText.classList.toggle('over', data.cap_exceeded);
  document.getElementById('cap-used-label').textContent = `${(data.capped_total_m2||0).toFixed(1)} mÂ² used`;
  document.getElementById('cap-limit-label').textContent = `limit: ${(data.cap_limit_m2||0).toFixed(1)} mÂ²`;

  // Concessions breakdown
  const concessions = data.concessions || [];
  const concSection = document.getElementById('concessions-section');
  const concGrid    = document.getElementById('concessions-grid');
  if (concessions.length > 0) {
    // Sort by item_no numerically
    const sorted = [...concessions].sort((a, b) => {
      return parseFloat(a.item_no || 99) - parseFloat(b.item_no || 99);
    });
    concSection.style.display = 'block';
    concGrid.innerHTML = sorted.map(c => {
      const capTag    = c.subject_to_cap  ? `<span class="concession-tag cap">Cap-subject</span>` : `<span class="concession-tag free">Cap-exempt</span>`;
      const bpTag     = c.requires_beam_plus ? `<span class="concession-tag bp">BEAM+</span>` : '';
      const prereqTag = c.requires_prereq ? `<span class="concession-tag prereq">Pre-req</span>` : '';
      const warnTag   = c.cap_warning     ? `<span class="concession-tag warn">âš  Exceeded</span>` : '';
      const itemBadge = c.item_no         ? `<span class="item-no-badge">Item ${c.item_no}</span>` : '';
      const pnapRef   = c.pnap_ref        ? `<div class="pnap-ref">${c.pnap_ref}</div>` : '';
      return `
        <div class="concession-row${c.cap_warning ? ' conc-exceeded' : ''}">
          <div class="concession-name">
            <div class="conc-header">${itemBadge} ${c.item}</div>
            <div class="conc-meta">${capTag}${bpTag}${prereqTag}${warnTag}${pnapRef}</div>
          </div>
          <div class="concession-area">${c.effective_gfa_m2.toFixed(2)} mÂ²</div>
        </div>`;
    }).join('');
  } else {
    concSection.style.display = 'none';
  }

  // Warnings
  const warnList = document.getElementById('warnings-list');
  warnList.innerHTML = (data.warnings || []).map(w => {
    const isDanger = w.includes('exceeded') || w.includes('cap exceeded');
    return `<div class="warning-item ${isDanger ? 'danger' : ''}">âš  ${w}</div>`;
  }).join('');

  // Room table
  const tbody = document.getElementById('room-tbody');
  tbody.innerHTML = (data.rooms || []).map(r => {
    const ruleClass = r.gfa_rule === 'full' ? 'full'
                    : r.gfa_rule === 'excluded' ? 'excl'
                    : r.gfa_rule === 'half' ? 'half' : 'cond';
    const warn = r.gfa_note && r.gfa_note.includes('âš ï¸')
      ? `<div class="td-warn">âš  Review</div>` : '';
    const itemCell = r.item_no
      ? `<span class="item-no-badge small">Item ${r.item_no}</span>`
      : (r.concession ? `<span style="font-size:10px;color:var(--muted)">${r.concession}</span>` : 'â€”');
    return `
      <tr>
        <td class="td-label">${r.label}${warn}</td>
        <td class="td-floor">${r.floor}</td>
        <td>${r.polygon_m2.toFixed(2)}</td>
        <td><span class="td-rule ${ruleClass}">${r.gfa_rule}</span></td>
        <td>${r.gfa_m2.toFixed(2)}</td>
        <td>${r.nofa_m2.toFixed(2)}</td>
        <td>${itemCell}</td>
      </tr>`;
  }).join('');

  // Download Excel button
  const dlBtn = document.getElementById('btn-download');
  if (data.download_url) {
    dlBtn.href = `${API_BASE}${data.download_url}`;
    dlBtn.style.display = 'flex';
  } else {
    dlBtn.style.display = 'none';
  }

  // Reset annotated PDF button (will be populated by _doAnnotate)
  const pdfBtn = document.getElementById('btn-download-pdf');
  pdfBtn.style.display = 'none';
  pdfBtn.style.color = '';
  pdfBtn.style.borderColor = '';

  // Show results
  resultsEl.classList.add('visible');
  resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â”€â”€ Scale helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleScaleChange(sel) {
  const wrap = document.getElementById('custom-scale-wrap');
  wrap.style.display = sel.value === 'custom' ? 'block' : 'none';
  if (sel.value === 'custom') document.getElementById('custom-scale').focus();
}

function getScale() {
  const sel = document.getElementById('draw-scale');
  if (sel.value === 'custom') {
    const v = parseInt(document.getElementById('custom-scale').value, 10);
    return (!v || v < 1) ? null : v;
  }
  return parseInt(sel.value, 10);
}

function validateCustomScale(input) {
  const v = parseInt(input.value, 10);
  input.style.borderColor = (!v || v < 1 || v > 9999) ? 'var(--danger)' : 'var(--accent2)';
}

// â”€â”€ Modal keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  const modal = document.getElementById('scale-modal');
  if (!modal.classList.contains('visible')) return;
  if (e.key === 'Enter')  confirmScale();
  if (e.key === 'Escape') cancelModal();
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkHealth();
loadRules();
</script>
</body>
</html>
